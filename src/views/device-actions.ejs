<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="https://unpkg.com/semantic-ui/dist/semantic.min.css">
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
    <script src="https://unpkg.com/semantic-ui/dist/semantic.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
        }
        .main.container {
            margin-top: 2em;
        }
    </style>
</head>
<body>
    <div class="ui main container">
        <!-- Header -->
        <div class="ui secondary menu">
            <div class="item">
                <h2 class="ui header">
                    <i class="whatsapp icon"></i>
                    <div class="content">
                        WhatsApp Analytics
                    </div>
                </h2>
            </div>
            <div class="right menu">
                <a href="/dashboard" class="ui item">
                    <i class="arrow left icon"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <h1 class="ui header">
            <%= device.deviceName %>
            <div class="sub header">
                Phone: <%= device.phone || 'Not linked' %> | 
                Device ID: <%= device.id.substring(0, 8) + '...' %>
            </div>
        </h1>

        <% if (device.status !== 'online') { %>
            <div class="ui warning message">
                <i class="warning icon"></i>
                Device is offline. Please connect the device first to use actions.
            </div>
        <% } %>

        <!-- Send Test Message -->
        <div class="ui segment">
            <h3 class="ui header">
                <i class="paper plane icon"></i>
                <div class="content">Send Test Message</div>
            </h3>
            
            <form class="ui form" id="sendMessageForm">
                <div class="two fields">
                    <div class="field">
                        <label>Phone Number</label>
                        <div class="ui left icon input">
                            <i class="phone icon"></i>
                            <input type="text" id="phoneNumber" placeholder="+60123456789" required>
                        </div>
                    </div>
                    <div class="field">
                        <label>Message</label>
                        <input type="text" id="message" placeholder="Enter your test message..." required>
                    </div>
                </div>
                <button class="ui green button" type="submit" <%= device.status !== 'online' ? 'disabled' : '' %>>
                    <i class="send icon"></i> Send Message
                </button>
            </form>
        </div>
        <!-- Send Test Image -->
        <div class="ui segment">
            <h3 class="ui header">
                <i class="image icon"></i>
                <div class="content">Send Test Image</div>
            </h3>
            
            <form class="ui form" id="sendImageForm">
                <div class="two fields">
                    <div class="field">
                        <label>Phone Number</label>
                        <div class="ui left icon input">
                            <i class="phone icon"></i>
                            <input type="text" id="imagePhone" placeholder="+60123456789" required>
                        </div>
                    </div>
                    <div class="field">
                        <label>Image</label>
                        <input type="file" id="imageFile" accept="image/*" required>
                        <small>Max 350KB. Will be compressed automatically.</small>
                    </div>
                </div>
                <div class="field">
                    <label>Caption (Optional)</label>
                    <textarea id="imageCaption" rows="2" placeholder="Add a caption to your image..."></textarea>
                </div>
                <button class="ui green button" type="submit" <%= device.status !== 'online' ? 'disabled' : '' %>>
                    <i class="upload icon"></i> Send Image
                </button>
            </form>
        </div>

        <!-- Check Number Status -->
        <div class="ui segment">
            <h3 class="ui header">
                <i class="check circle icon"></i>
                <div class="content">Check Number Status</div>
            </h3>
            
            <form class="ui form" id="checkPhoneForm">
                <div class="ui action input fluid">
                    <input type="text" id="checkPhone" placeholder="+60123456789" required>
                    <button class="ui teal button" type="submit" <%= device.status !== 'online' ? 'disabled' : '' %>>
                        <i class="search icon"></i> Check Status
                    </button>
                </div>
            </form>
        </div>

        <!-- Test Broadcast -->
        <div class="ui segment">
            <h3 class="ui header">
                <i class="bullhorn icon"></i>
                <div class="content">Test Broadcast</div>
            </h3>
            
            <form class="ui form" id="broadcastForm">
                <div class="field">
                    <label>Phone Numbers (comma separated, without +)</label>
                    <textarea id="broadcastPhones" rows="2" placeholder="60123456789, 60987654321" required></textarea>
                    <small>Include country code (e.g. 60 for Malaysia)</small>
                </div>
                <div class="field">
                    <label>Message</label>
                    <textarea id="broadcastMessage" rows="3" placeholder="Broadcast message..." required></textarea>
                </div>
                <div class="field">
                    <label>Image (Optional)</label>
                    <input type="file" id="broadcastImage" accept="image/*">
                    <small>Max 350KB. Will be compressed automatically.</small>
                </div>
                <div class="field">
                    <label>Schedule Time (Optional)</label>
                    <input type="datetime-local" id="scheduleTime">
                    <small>Leave empty to send immediately</small>
                </div>
                <button class="ui orange button" type="submit" <%= device.status !== 'online' ? 'disabled' : '' %>>
                    <i class="send icon"></i> Send Broadcast
                </button>
            </form>
        </div>

        <!-- Activity Log -->
        <div class="ui segment">
            <h3 class="ui header">
                <i class="history icon"></i>
                <div class="content">Activity Log</div>
            </h3>
            
            <div class="ui feed" id="activityLog">
                <div class="event">
                    <div class="content">
                        <div class="summary">No activity yet. Start testing above!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const deviceId = '<%= device.id %>';
        const activities = [];
        
        function addActivity(message, type = 'info') {
            const icon = type === 'success' ? 'check green' : type === 'error' ? 'times red' : 'info blue';
            const time = new Date().toLocaleTimeString();
            
            activities.unshift({ time, message, icon });
            
            const log = document.getElementById('activityLog');
            log.innerHTML = activities.slice(0, 10).map(a => `
                <div class="event">
                    <div class="label">
                        <i class="${a.icon} icon"></i>
                    </div>
                    <div class="content">
                        <div class="date">${a.time}</div>
                        <div class="summary">${a.message}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Send message form
        document.getElementById('sendMessageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const phone = document.getElementById('phoneNumber').value;
            const message = document.getElementById('message').value;
            const button = e.target.querySelector('button');
            
            button.classList.add('loading');
            addActivity(`Sending message to ${phone}`, 'info');
            
            try {
                const response = await fetch(`/api/messages/${deviceId}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: phone, message })
                });
                
                const data = await response.json();
                button.classList.remove('loading');
                
                if (response.ok) {
                    addActivity(`Message sent to ${phone}`, 'success');
                    swal("Success!", "Message sent successfully!", "success");
                    document.getElementById('sendMessageForm').reset();
                } else {
                    addActivity(`Failed to send to ${phone}: ${data.error}`, 'error');
                    swal("Error!", data.error || "Failed to send message", "error");
                }
            } catch (error) {
                button.classList.remove('loading');
                addActivity(`Error: ${error.message}`, 'error');
                swal("Error!", "Failed to send message", "error");
            }
        });
        
        // Other form handlers can be added similarly
        document.getElementById('checkPhoneForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('checkPhone').value;
            addActivity(`Checking phone status for ${phone}`, 'info');
            swal("Info", "Phone checking feature coming soon!", "info");
        });
    </script>
</body>
</html>