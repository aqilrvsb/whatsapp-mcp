<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="https://unpkg.com/semantic-ui/dist/semantic.min.css">
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
    <script src="https://unpkg.com/semantic-ui/dist/semantic.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
        }
        .main.container {
            margin-top: 2em;
        }
        .ui.statistics {
            margin-bottom: 2em;
        }
        .ui.statistic > .value {
            color: #00a884;
        }
    </style>
</head>
<body>
    <div class="ui main container">
        <!-- Header -->
        <div class="ui segment" style="background: linear-gradient(135deg, #128c7e 0%, #075e54 100%); color: white;">
            <h1 class="ui header" style="color: white;">
                <i class="whatsapp icon"></i>
                <div class="content">
                    WhatsApp Analytics
                    <div class="sub header" style="color: rgba(255,255,255,0.8);">Multi-user analytics dashboard</div>
                </div>
            </h1>
        </div>
        <!-- User Info Bar -->
        <div class="ui secondary menu">
            <div class="item">
                <i class="user icon"></i> <%= user.fullName %>
            </div>
            <div class="right menu">
                <a href="/logout" class="ui item">
                    <i class="sign out icon"></i> Logout
                </a>
            </div>
        </div>

        <!-- Tabs -->
        <div class="ui top attached tabular menu">
            <a class="active item" data-tab="dashboard">
                <i class="chart line icon"></i> Dashboard
            </a>
            <a class="item" data-tab="devices">
                <i class="mobile alternate icon"></i> Devices
            </a>
            <a class="item" data-tab="campaign">
                <i class="bullhorn icon"></i> Campaign
            </a>
        </div>

        <!-- Dashboard Tab -->
        <div class="ui bottom attached active tab segment" data-tab="dashboard">
            <h2 class="ui header">
                Analytics Overview
                <div class="sub header">Today: <%= new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %> | Last refresh: Never</div>
            </h2>

            <!-- Time Range Toggle -->
            <div class="ui compact menu" style="margin-bottom: 2em;">
                <a class="item active">Today</a>
                <a class="item">7 Days</a>
                <a class="item">30 Days</a>
                <a class="item">90 Days</a>
                <a class="item">Custom</a>
            </div>

            <!-- Statistics Cards -->
            <div class="ui four statistics">
                <div class="ui green statistic">
                    <div class="value">
                        <i class="mobile alternate icon"></i> <span id="activeDevices">0</span>
                    </div>
                    <div class="label">Active Devices</div>
                </div>
                <div class="statistic">
                    <div class="value">
                        <span id="inactiveDevices">0</span>
                    </div>
                    <div class="label">Inactive Devices</div>
                </div>
                <div class="ui blue statistic">
                    <div class="value">
                        <i class="paper plane icon"></i> <span id="leadsSent">0</span>
                    </div>
                    <div class="label">Leads Sent</div>
                </div>
                <div class="ui teal statistic">
                    <div class="value">
                        <i class="envelope open icon"></i> <span id="leadsReceived">0</span>
                    </div>
                    <div class="label">Leads Received<br>0%</div>
                </div>
            </div>
            <div class="ui four statistics" style="margin-top: 2em;">
                <div class="ui yellow statistic">
                    <div class="value">
                        <i class="times circle icon"></i> <span id="leadsNotReceived">0</span>
                    </div>
                    <div class="label">Leads Not Received<br>0%</div>
                </div>
                <div class="statistic">
                    <div class="value">
                        <i class="check circle icon"></i> <span id="leadsRead">0</span>
                    </div>
                    <div class="label">Leads Read<br>0%</div>
                </div>
                <div class="statistic">
                    <div class="value">
                        <span id="leadsNotRead">0</span>
                    </div>
                    <div class="label">Leads Not Read<br>0%</div>
                </div>
                <div class="ui blue statistic">
                    <div class="value">
                        <i class="reply icon"></i> <span id="leadsReplied">0</span>
                    </div>
                    <div class="label">Leads Replied<br>0%</div>
                </div>
            </div>

            <!-- Daily Message Activity Chart -->
            <div class="ui segment" style="margin-top: 2em;">
                <h3 class="ui header">Daily Message Activity</h3>
                <canvas id="messageChart" style="height: 300px;"></canvas>
            </div>
        </div>

        <!-- Devices Tab -->
        <div class="ui bottom attached tab segment" data-tab="devices">
            <div class="ui grid">
                <div class="twelve wide column">
                    <h2 class="ui header">
                        WhatsApp Devices
                        <div class="sub header">Manage your connected WhatsApp accounts</div>
                    </h2>
                </div>
                <div class="four wide column">
                    <button class="ui primary button right floated" onclick="addNewDevice()">
                        <i class="plus icon"></i> Add Device
                    </button>
                </div>
            </div>

            <div class="ui cards" id="devicesGrid" style="margin-top: 2em;">
                <!-- Device cards will be loaded here -->
            </div>
        </div>

        <!-- Campaign Tab -->
        <div class="ui bottom attached tab segment" data-tab="campaign">
            <h2 class="ui header">
                Campaign Calendar
                <div class="sub header">Plan and schedule your WhatsApp broadcast campaigns</div>
            </h2>
            
            <div id="campaignCalendar" style="margin-top: 2em;">
                <!-- Calendar will be loaded here -->
            </div>
        </div>
    </div>
    <!-- Add Device Modal -->
    <div class="ui modal" id="addDeviceModal">
        <i class="close icon"></i>
        <div class="header">
            <i class="mobile alternate icon"></i> Add New Device
        </div>
        <div class="content">
            <form class="ui form" id="addDeviceForm">
                <div class="field">
                    <label>Device Name</label>
                    <input type="text" id="deviceName" placeholder="e.g. Work Phone" required>
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui black deny button">Cancel</div>
            <div class="ui positive right labeled icon button" onclick="submitAddDevice()">
                Add Device
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>

    <script>
        // Initialize Semantic UI tabs
        $('.menu .item').tab();
        
        // Auto-refresh toggle
        let autoRefresh = false;
        let refreshInterval;

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load devices
                const devicesResponse = await fetch('/api/devices');
                const devices = await devicesResponse.json();
                
                // Update device counts
                const activeDevices = devices.filter(d => d.status === 'online').length;
                const inactiveDevices = devices.filter(d => d.status === 'offline').length;
                
                document.getElementById('activeDevices').textContent = activeDevices;
                document.getElementById('inactiveDevices').textContent = inactiveDevices;
                
                // Render devices
                renderDevices(devices);
                
                // Load analytics
                const analyticsResponse = await fetch('/api/analytics/dashboard');
                const analytics = await analyticsResponse.json();
                
                // Update other metrics
                document.getElementById('leadsSent').textContent = analytics.messagesSent || 0;
                document.getElementById('leadsReceived').textContent = analytics.messagesReceived || 0;
                
                // Initialize chart
                initChart();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Render devices in Semantic UI cards
        function renderDevices(devices) {
            const grid = document.getElementById('devicesGrid');
            
            if (devices.length === 0) {
                grid.innerHTML = `
                    <div class="ui message">
                        <div class="header">No devices connected</div>
                        <p>Add a device to start using WhatsApp Analytics</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = devices.map(device => {
                const isOnline = device.status === 'online';
                return `
                    <div class="ui card ${isOnline ? 'green' : ''}">
                        <div class="content">
                            <div class="header">
                                <i class="mobile alternate icon"></i> ${device.deviceName}
                            </div>
                            <div class="meta">
                                <span class="${isOnline ? 'green' : 'red'} text">
                                    <i class="circle icon"></i> ${device.status}
                                </span>
                            </div>
                            <div class="description">
                                <p>Phone Number<br>
                                ${device.phone || 'Not linked'} 
                                ${!device.phone ? `<a href="#" onclick="linkPhone('${device.id}')">Add</a>` : ''}</p>
                                <p>Last active<br>${new Date(device.lastSeen).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="extra content">
                            <div class="ui two buttons">
                                ${isOnline ? 
                                    `<button class="ui green button" onclick="openWhatsAppWeb('${device.id}')">
                                        <i class="whatsapp icon"></i> WhatsApp Web
                                    </button>` :
                                    `<button class="ui blue button" onclick="connectDevice('${device.id}')">
                                        <i class="qrcode icon"></i> QR Code
                                    </button>`
                                }
                                <div class="ui dropdown button">
                                    <i class="ellipsis vertical icon"></i>
                                    <div class="menu">
                                        <div class="item" onclick="window.location.href='/device/${device.id}/actions'">
                                            <i class="wrench icon"></i> Actions
                                        </div>
                                        <div class="item" onclick="window.location.href='/device/${device.id}/leads'">
                                            <i class="users icon"></i> Leads
                                        </div>
                                        <div class="divider"></div>
                                        <div class="item" onclick="logoutDevice('${device.id}')">
                                            <i class="sign out icon"></i> Logout
                                        </div>
                                        <div class="item" onclick="deleteDevice('${device.id}')">
                                            <i class="trash icon"></i> Delete
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Initialize dropdowns
            $('.ui.dropdown').dropdown();
        }
        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('messageChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [
                        {
                            label: 'Leads Sent',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#128c7e',
                            backgroundColor: 'rgba(18, 140, 126, 0.1)'
                        },
                        {
                            label: 'Leads Received',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#25d366',
                            backgroundColor: 'rgba(37, 211, 102, 0.1)'
                        },
                        {
                            label: 'Leads Read',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#34b7f1',
                            backgroundColor: 'rgba(52, 183, 241, 0.1)'
                        },
                        {
                            label: 'Leads Replied',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#00a884',
                            backgroundColor: 'rgba(0, 168, 132, 0.1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Lead Activity Trends'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Device operations
        function addNewDevice() {
            $('#addDeviceModal').modal('show');
        }

        async function submitAddDevice() {
            const deviceName = document.getElementById('deviceName').value;
            if (!deviceName) return;
            
            try {
                const response = await fetch('/api/devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceName })
                });
                
                if (response.ok) {
                    $('#addDeviceModal').modal('hide');
                    document.getElementById('deviceName').value = '';
                    loadDashboard();
                    swal("Success!", "Device added successfully", "success");
                }
            } catch (error) {
                console.error('Error adding device:', error);
                swal("Error!", "Failed to add device", "error");
            }
        }

        function connectDevice(deviceId) {
            window.location.href = `/api/devices/${deviceId}/qr`;
        }

        function openWhatsAppWeb(deviceId) {
            window.location.href = `/device/${deviceId}/whatsapp`;
        }

        async function deleteDevice(deviceId) {
            const willDelete = await swal({
                title: "Are you sure?",
                text: "Once deleted, you will not be able to recover this device!",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            });
            
            if (willDelete) {
                try {
                    const response = await fetch(`/api/devices/${deviceId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        swal("Device deleted successfully!", {
                            icon: "success",
                        });
                        loadDashboard();
                    }
                } catch (error) {
                    console.error('Error deleting device:', error);
                    swal("Error!", "Failed to delete device", "error");
                }
            }
        }

        async function logoutDevice(deviceId) {
            try {
                const response = await fetch(`/api/devices/${deviceId}/logout`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    swal("Success!", "Device logged out", "success");
                    loadDashboard();
                }
            } catch (error) {
                console.error('Error logging out device:', error);
                swal("Error!", "Failed to logout device", "error");
            }
        }

        // Initialize calendar for campaign tab
        function initCalendar() {
            // TODO: Implement calendar
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            
            // Auto-refresh every 10 seconds
            setInterval(loadDashboard, 10000);
        });
    </script>
</body>
</html>